{"version":3,"sources":["./src/app/pages/monitor/monitor.component.ts","./src/app/pages/monitor/monitor.component.html","./src/app/pages/monitor/monitor-routing.module.ts","./src/app/pages/monitor/monitor.module.ts"],"names":[],"mappings":"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","file":"pages-monitor-monitor-module.js","sourcesContent":["import { Component, OnInit } from '@angular/core';\nimport { HttpClient } from '@angular/common/http';\nimport { timer } from 'rxjs';\n\nimport { Metric } from './Metric';\n\nimport * as Highcharts from 'highcharts';\nimport theme from 'highcharts/themes/dark-unica';\ntheme(Highcharts);\n\n@Component({\n  selector: 'app-monitor',\n  templateUrl: './monitor.component.html',\n  styleUrls: ['./monitor.component.css']\n})\nexport class MonitorComponent implements OnInit {\n\n  Highcharts: typeof Highcharts = Highcharts;\n\n  metricCount_chart: any;\n  metricCount_chartCallback: any;\n  metricCount_chartOptions: Highcharts.Options = {\n    chart: {\n      type: 'spline',\n    },\n    time: {\n      useUTC: false,\n    },\n    title: {\n      \"text\": '数据处理监控'\n    },\n    xAxis: {\n      type: 'datetime',\n      dateTimeLabelFormats: {\n        day: '%m-%d',\n      },\n      labels: {\n        overflow: 'justify',\n      },\n    },\n    yAxis: {\n      allowDecimals: false,\n      title: {\n        text: \"次数\"\n      }\n    },\n    tooltip: {\n      headerFormat: '<b>{point.x:%Y-%m-%d %H:%M:%S}</b><br>',\n      pointFormat: '{point.y:.2f}',\n    },\n    plotOptions: {\n      spline: {\n        marker: {\n          enabled: true\n        }\n      }\n    },\n    series: [{\n      type: 'spline',\n      name: \"数据保存次数\",\n      data: []\n    },\n    {\n      type: 'spline',\n      name: \"数据丢弃次数\",\n      data: []\n    }]\n  };\n\n  queryCount_chart: any;\n  queryCount_chartCallback: any;\n  queryCount_chartOptions: Highcharts.Options = {\n    chart: {\n      type: 'spline',\n    },\n    time: {\n      useUTC: false,\n    },\n    title: {\n      \"text\": '查询性能监控'\n    },\n    xAxis: {\n      type: 'datetime',\n      dateTimeLabelFormats: {\n        day: '%m-%d',\n      },\n      labels: {\n        overflow: 'justify',\n      },\n    },\n    yAxis: {\n      allowDecimals: false,\n      title: {\n        text: \"次数\"\n      }\n    },\n    tooltip: {\n      formatter: function () {\n        let point: any = this.point;\n        console.log(point);\n        return '<b>count: ' + point.y + '</b><br><b>avg: '\n          + point.avg + '</b><br><b>max: ' + point.max + '</b><br><b>95th: ' \n          + point.th95 + '</b><br><b>99th: ' + point.th99 + '</b><br>';\n      }\n    },\n    plotOptions: {\n      spline: {\n        marker: {\n          enabled: true\n        }\n      }\n    },\n    series: [{\n      type: 'spline',\n      name: \"查询次数\",\n      data: []\n    }]\n  };\n\n  constructor(private httpClient: HttpClient) {\n    const self = this;\n    this.metricCount_chartCallback = (chart: Highcharts.Chart) => {\n      self.metricCount_chart = chart;\n    }\n    this.queryCount_chartCallback = (chart: Highcharts.Chart) => {\n      self.queryCount_chart = chart;\n    }\n  }\n\n  ngOnInit() {\n\n    const source = timer(1000, 30 * 1000);\n    const subscribe = source.subscribe(val => this.getMessage());\n  }\n\n  getMessage() {\n    let url = '/monitor';\n    this.httpClient.get(url).subscribe((data: any) => {\n      let metrics: Metric[] = data;\n      // 获取数据处理指标\n      metrics.forEach(metric => {\n        if (metric.name === 'dp.metricValue.count.save') {\n          this.metricCount_chart.series[0].addPoint(metric.datapoints[0], true, false);\n        } else if (metric.name === 'dp.metricValue.count.drop') {\n          this.metricCount_chart.series[1].addPoint(metric.datapoints[0], true, false);\n        }\n      });\n      // 获取查询性能指标\n      let queryMetric: any = {};\n      metrics.forEach(metric => {\n        if (metric.name === 'dp.query.timer.count') {\n          queryMetric['x'] = metric.datapoints[0][0];\n          queryMetric['y'] = metric.datapoints[0][1];\n        } else if (metric.name === 'dp.query.timer.max') {\n          queryMetric['max'] = metric.datapoints[0][1];\n        } else if (metric.name === 'dp.query.timer.avg') {\n          queryMetric['avg'] = metric.datapoints[0][1];\n        } else if (metric.name === 'dp.query.timer.percentile') {\n          if (metric.tags['phi'] === '0.99') {\n            queryMetric['th99'] = metric.datapoints[0][1];\n          }else if (metric.tags['phi'] === '0.95') {\n            queryMetric['th95'] = metric.datapoints[0][1];\n          }\n        }\n      });\n      this.queryCount_chart.series[0].addPoint(queryMetric, true, false);\n\n    })\n\n  }\n\n}\n","<div nz-row>\n    <div nz-col nzSpan=\"24\">\n        <highcharts-chart [Highcharts]=\"Highcharts\" [options]=\"metricCount_chartOptions\"\n            [callbackFunction]=\"metricCount_chartCallback\" [oneToOne]=\"true\" style=\"width: 100%; height: 400px; display: block;\"></highcharts-chart>\n    </div>\n</div>\n<div nz-row style=\"margin-top: 20px;\">\n    <div nz-col nzSpan=\"24\">\n        <highcharts-chart [Highcharts]=\"Highcharts\" [options]=\"queryCount_chartOptions\"\n            [callbackFunction]=\"queryCount_chartCallback\" [oneToOne]=\"true\" style=\"width: 100%; height: 400px; display: block;\"></highcharts-chart>\n    </div>\n</div>","import { NgModule } from '@angular/core';\nimport { Routes, RouterModule } from '@angular/router';\nimport { MonitorComponent } from './monitor.component';\n\nconst routes: Routes = [\n  { path: '', component: MonitorComponent },\n];\n\n@NgModule({\n  imports: [RouterModule.forChild(routes)],\n  exports: [RouterModule]\n})\nexport class MonitorRoutingModule { }\n","import { NgModule } from '@angular/core';\n\nimport { MonitorRoutingModule } from './monitor-routing.module';\n\nimport { MonitorComponent } from './monitor.component';\nimport { HighchartsChartModule } from 'highcharts-angular';\n\n@NgModule({\n  imports: [\n    MonitorRoutingModule,\n    HighchartsChartModule\n  ],\n  declarations: [MonitorComponent],\n  exports: [MonitorComponent]\n})\nexport class MonitorModule { }\n"],"sourceRoot":"webpack:///"}